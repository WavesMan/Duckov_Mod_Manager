# Mod Manager Bridge 系统架构设计

## 执行摘要

本文档提供了 Duckov Mod Manager Bridge 系统的全面架构设计，该系统在游戏原生模组管理系统与外部模组管理工具之间提供了标准化、安全且高效的桥梁。

## 系统概述

Mod Manager Bridge 系统实现了基于 WebSocket 的通信协议，使外部工具能够在不修改核心游戏文件的情况下管理 Duckov 模组。该系统遵循桥接中继模式，具备完整的错误处理、性能监控和安全功能。

## 架构组件

### 1. 核心桥接组件

#### 1.1 ModBehaviour（入口点）
- **目的**：与 Unity 生命周期集成的主要模组入口点
- **位置**：`ModBehaviour.cs`
- **职责**：
  - 在游戏启动时初始化桥接服务
  - 管理 WebSocket 服务器生命周期
  - 协调系统组件
  - 处理优雅关闭

#### 1.2 BridgeServer（WebSocket 服务器）
- **目的**：管理 WebSocket 连接和客户端通信
- **位置**：`Core/BridgeServer.cs`
- **特性**：
  - 多客户端连接支持
  - 子协议协商（`duckov-mods-v1`）
  - 连接池和管理
  - 实时消息广播

#### 1.3 WebSocketConnection（连接处理器）
- **目的**：单个连接管理和消息处理
- **位置**：`Core/WebSocketConnection.cs`
- **能力**：
  - 请求/响应关联
  - 消息验证和解析
  - 连接状态管理
  - 自动重连处理

### 3. 操作管理系统

#### 3.1 ModOperationManager
- **目的**：异步操作处理和队列管理
- **位置**：`Core/ModOperationManager.cs`
- **关键特性**：
  - 双缓冲队列设计（待处理/处理中）
  - 批处理（每批最多 50 个模组）
  - 指数退避重试机制
  - 并发操作控制（最多 4 个线程）
  - 操作历史跟踪

#### 3.2 操作类型
- **模组生命周期**：`activate_mod`、`deactivate_mod`
- **优先级管理**：`set_priority`
- **配置**：`get_settings`、`set_allow_loading`
- **信息**：`scan_mods`、`get_mods`

### 4. 监控和健康系统

#### 4.1 HeartbeatMonitor
- **目的**：系统健康监控和降级处理
- **位置**：`Core/HeartbeatMonitor.cs`
- **监控能力**：
  - CPU 使用率监控（80% 阈值）
  - 内存使用跟踪（45MB 阈值）
  - 连接健康评估
  - 负载下的自动降级

#### 4.2 PerformanceMonitor
- **目的**：性能指标收集和分析
- **位置**：`Core/PerformanceMonitor.cs`
- **跟踪指标**：
  - 操作响应时间
  - 队列深度和处理速率
  - 错误率和模式
  - 资源利用趋势

### 5. 容错机制

#### 5.1 CircuitBreaker
- **目的**：容错和自动恢复
- **位置**：`Core/CircuitBreaker.cs`
- **特性**：
  - 滑动窗口错误率计算
  - 30% 错误率阈值
  - 带冷却的自动恢复
  - 按操作类型的断路器

#### 5.2 重试机制
- **配置**：
  - 初始延迟：100ms
  - 最大延迟：800ms
  - 最大尝试次数：3
  - 指数退避乘数

## 数据模型和协议

### WebSocket 消息协议

#### 消息结构
```json
{
  "type": "request|response|event",
  "action": "operation_name",
  "id": "unique_message_id",
  "data": { /* 操作特定数据 */ },
  "error": { /* 错误信息（如适用） */ }
}
```

#### 核心操作

##### 扫描模组
**请求**：`{ "type": "request", "action": "scan_mods", "id": "..." }`
**响应**：包含带元数据的模组信息数组

##### 激活模组
**请求**：`{ "type": "request", "action": "activate_mod", "id": "...", "data": { "name": "mod_name" } }`
**响应**：带操作结果的状态确认

##### 获取模组
**请求**：`{ "type": "request", "action": "get_mods", "id": "..." }`
**响应**：包含活动状态和优先级的完整模组列表

### 事件系统

#### 实时事件
- `mods_scanned`：模组扫描完成时触发
- `mod_activated`：模组激活时触发
- `mod_will_deactivate`：停用前通知
- `mod_status_changed`：通用状态变更通知
- `mod_loading_failed`：加载失败通知
- `mods_reordered`：优先级重新排序通知

## 安全架构

### 认证机制
1. **基于令牌**：本地存储的安全令牌
2. **HMAC 签名**：带时间戳的 SHA256 HMAC
3. **时间窗口**：5 分钟验证窗口
4. **随机数使用**：单次使用的挑战-响应

### 访问控制
- **IP 白名单**：默认仅限本地主机
- **速率限制**：每个客户端每分钟 60 次请求
- **权限粒度**：
  - `read_mods`：只读访问
  - `manage_activation`：激活/停用模组
  - `manage_priority`：更改模组优先级
  - `manage_settings`：修改系统设置

### 数据保护
- **无敏感日志**：令牌和密钥不记录到日志
- **安全存储**：带保护的本地令牌存储
- **消息加密**：WebSocket 连接的可选 TLS

## 性能架构

### 并发设计
- **线程池**：动态大小调整（4-16 个线程）
- **队列管理**：带背压的双缓冲
- **批处理**：最优批量大小计算
- **连接池**：可重用的连接资源

### 资源管理
- **内存优化**：高效的对象池
- **超时控制**：3 秒操作超时
- **背压处理**：队列容量限制
- **垃圾回收**：最小化的分配模式

### 监控指标
- **响应时间**：操作延迟跟踪
- **吞吐量**：每秒操作数
- **错误率**：失败百分比监控
- **资源使用**：CPU 和内存消耗

## 集成架构

### Duckov API 集成
- **事件订阅**：原生模组管理器事件
- **生命周期管理**：与游戏生命周期的无缝集成
- **错误处理**：一致的错误传播
- **状态同步**：实时状态更新

### 外部工具集成
- **WebSocket 协议**：标准化通信
- **REST API**：可选的 HTTP 端点
- **SDK 支持**：流行语言的客户端库
- **文档**：OpenAPI 3.0 规范

## 部署架构

### 安装过程
1. **模组放置**：复制到 Duckov 的 Mods 目录
2. **自动初始化**：随游戏自动启动
3. **配置**：运行时配置管理
4. **验证**：启动时的健康检查

### 运行时管理
- **动态配置**：运行时参数调整
- **优雅关闭**：干净的资源清理
- **健康监控**：持续的系统健康检查
- **日志管理**：带轮转的结构化日志

## 可扩展性考虑

### 水平扩展
- **多实例**：支持多个桥接实例
- **负载均衡**：客户端连接分发
- **状态共享**：分布式状态管理
- **配置同步**：跨实例配置

### 垂直扩展
- **资源优化**：高效的资源利用
- **内存管理**：可扩展的内存模式
- **CPU 优化**：多线程处理
- **网络效率**：优化的消息协议

## 未来增强

### 计划功能
1. **插件架构**：可扩展的操作插件
2. **高级分析**：增强的监控能力
3. **机器学习**：预测性故障检测
4. **云集成**：远程管理能力

### 兼容性路线图
- **版本管理**：向后兼容性维护
- **协议演进**：优雅的协议升级
- **功能标志**：渐进式功能推出
- **迁移工具**：无缝升级路径

## 结论

Mod Manager Bridge 系统为 Duckov 的外部模组管理集成提供了一个稳健、安全且可扩展的解决方案。该架构强调可靠性、性能和可维护性，同时保持与游戏原生模组管理系统的完全兼容。

系统的模块化设计允许轻松扩展和定制，同时提供生产部署所需的全面监控和容错能力。